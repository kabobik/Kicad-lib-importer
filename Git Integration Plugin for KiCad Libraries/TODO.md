# TODO — Git Integration Plugin for KiCad Libraries

> Согласовано: 13.02.2026

---

## Согласованные решения

| Решение | Выбор |
|---------|-------|
| **UI** | Единое окно-панель (вариант C) — все кнопки, вывод и настройки в одном окне |
| **SSH-ключи** | ed25519, файл `kicad_forgejo_ed25519`, passphrase опционально, авто-запись в `~/.ssh/config`, кнопка «Проверить соединение» |
| **Кнопка «Скопировать»** | Текстовое поле с `.pub` + кнопка копирования через wxPython clipboard |
| **Инструкция Forgejo** | Встроенный диалог внутри плагина (пошаговые подсказки) |
| **Приоритеты** | SSH Setup включён в MVP |
| **Адрес сервера** | Поле ввода в Settings (пользователь вводит хост + порт SSH) |
| **Путь к репозиторию** | Фиксированный путь, задаётся в Settings |
| **Хранение настроек** | INI-файл рядом с плагином (`config.ini`) |
| **Лицензия** | Без лицензии пока |

---

## Технические решения (дополнение)

### Структура папки плагина

```
~/.local/share/kicad/<version>/scripting/plugins/git_integration/
├── __init__.py          # регистрация плагина
├── main.py              # точка входа, Action Plugin class
├── git_service.py       # обёртка над git (subprocess)
├── ssh_service.py       # генерация ключей, ssh config, test connection
├── ui.py                # wxPython диалоги/окна
├── config.ini           # настройки (создаётся при первом запуске)
├── icon.png             # иконка для тулбара (24x24)
└── README.md            # краткая справка
```

### Файл `config.ini`

```ini
[server]
host = 
port = 22
user = git

[repository]
path = 

[ssh]
key_path = ~/.ssh/kicad_forgejo_ed25519

[fetch]
interval_sec = 300
timeout_sec = 10
```

### GIT_SSH_COMMAND

При нестандартном ключе (`kicad_forgejo_ed25519`) git не найдёт его автоматически.
Нужно передавать переменную окружения при каждом вызове git:

```python
env = os.environ.copy()
env["GIT_SSH_COMMAND"] = f"ssh -i {key_path} -o StrictHostKeyChecking=accept-new"
subprocess.run(["git", "pull"], env=env, cwd=repo_path, ...)
```

### Совместимость

| Параметр | Значение |
|----------|----------|
| KiCad | 7.x, 8.x (Python Action Plugin API) |
| Python | 3.8+ (поставляется с KiCad) |
| wxPython | Версия из KiCad (не устанавливать отдельно) |
| Внешние зависимости | **Нет** — только stdlib + wx из KiCad |

### Settings UI

Отдельное окно настроек (кнопка ⚙ в главном окне):

```
┌─────────────────────────────────────────┐
│  Настройки                              │
│─────────────────────────────────────────│
│  Сервер Forgejo:  [________________]    │
│  SSH порт:        [22___]               │
│  Путь к репозиторию: [________] [Обзор] │
│  Путь к SSH-ключу:   [________] [Обзор] │
│  Интервал проверки:  [5] минут          │
│─────────────────────────────────────────│
│           [Сохранить]  [Отмена]         │
└─────────────────────────────────────────┘
```

---

## Фаза 0 — Каркас [1-2 дня]

- [ ] Структура плагина (`main.py`, `git_service.py`, `ssh_service.py`, `ui.py`)
- [ ] Регистрация в KiCad, пункт меню + иконка
- [ ] `config.ini` — чтение/запись настроек
- [ ] Определение пути репозитория из Settings + проверка `.git`
- [ ] `GIT_SSH_COMMAND` — обёртка для всех git-вызовов с нестандартным ключом

## Фаза 1 — Git-ядро [2-3 дня]

- [ ] `git status` → отображение (изменённые, неотслеживаемые, текущая ветка)
- [ ] `git pull` → результат + обработка ошибок/конфликтов
- [ ] `git commit` (`git add .` + `git commit -m`) → диалог ввода сообщения
- [ ] `git push` → диалог подтверждения + обработка ошибок

## Фаза 2 — SSH Setup [1-2 дня]

- [ ] Генерация ed25519 ключа (`~/.ssh/kicad_forgejo_ed25519`)
- [ ] Отображение `.pub` в текстовом поле (read-only)
- [ ] Кнопка «Скопировать» (wxPython clipboard, смена текста на «✓ Скопировано» на 2 сек)
- [ ] Проверка существующих ключей (предупреждение + варианты: использовать / перезаписать / другое имя)
- [ ] Поле ввода passphrase (опционально, можно оставить пустым)
- [ ] Авто-запись блока `Host` в `~/.ssh/config`
- [ ] Кнопка «Проверить соединение» (`ssh -T git@server`)
- [ ] Встроенная инструкция по настройке Forgejo (пошаговый диалог):
  1. Открыть Forgejo → Settings → SSH Keys
  2. Нажать «Add Key»
  3. Вставить скопированный ключ
  4. Нажать Save

## Фаза 3 — UI-полировка [1-2 дня]

- [ ] Единое окно-панель с отображением ветки и вывода команд
- [ ] Иконка на тулбаре KiCad
- [ ] First-run wizard (проверка .git → SSH → генерация ключа → инструкция)
- [ ] Логирование в `~/.kicad_git_plugin.log`

## Фаза 4 — Стабилизация [1-2 дня]

- [ ] Тестирование на реальном репозитории библиотек
- [ ] Edge cases (нет сети, rejected push, merge-конфликты)
- [ ] README + документация

---

## Логика проверки актуальности репозитория

### Когда выполняется `git fetch`

| Триггер | Описание |
|---------|----------|
| **Открытие окна плагина** | Фоновый fetch при каждом открытии главного окна |
| **Перед Push** | Обязательный fetch перед отправкой — предотвращает rejected |
| **По кнопке Status** | Явный запрос пользователя |
| **По таймеру** | Тихий fetch каждые 5-10 минут (настраиваемый интервал в Settings) |

### Обработка timeout / нет сети

- **Fetch выполняется в фоновом потоке** (threading)
- Окно открывается **сразу**, статус обновляется когда fetch завершится
- Индикатор: `[↻ Проверка...]` → `[main] ⬇2 ⬆1` или `[main] ✓`
- При timeout (10 сек): показать `⚠ Сервер недоступен` + последний известный статус
- Локальные операции (status, commit) **не блокируются** при отсутствии сети

### Автоматический `git status` (dirty check)

- Выполняется **при открытии окна** — быстрая локальная операция
- Показывает количество изменённых / неотслеживаемых файлов
- Не требует сети

### Отображение статуса в окне

```
┌─────────────────────────────────────────────────────┐
│  [main] ⬇2 ⬆1  │  3 изменено, 1 новый  │ ↻ 2м назад │
└─────────────────────────────────────────────────────┘
```

- `⬇N` — коммитов позади remote (нужен Pull)
- `⬆N` — коммитов впереди remote (нужен Push)
- `✓` — полностью синхронизировано
- `⚠` — расхождение или сервер недоступен
- `↻ Xм назад` — время последнего успешного fetch

### Логика принятия решений

```python
# После fetch:
behind = int(git("rev-list", "HEAD..origin/main", "--count"))
ahead  = int(git("rev-list", "origin/main..HEAD", "--count"))

if behind > 0 and ahead == 0:
    # "Есть обновления (N). Рекомендуется Pull"
    status = STATUS_BEHIND

elif behind > 0 and ahead > 0:
    # "⚠ Расхождение: N↓ M↑. Сначала Pull, затем Push"
    status = STATUS_DIVERGED

elif behind == 0 and ahead > 0:
    # "Есть неотправленные коммиты (N). Push?"
    status = STATUS_AHEAD

else:
    # "✓ Синхронизировано"
    status = STATUS_SYNCED
```

### Блокировки при расхождении

| Операция | `SYNCED` | `AHEAD` | `BEHIND` | `DIVERGED` |
|----------|----------|---------|----------|------------|
| Pull     | ✓        | ✓       | ✓        | ✓ (с предупреждением) |
| Commit   | ✓        | ✓       | ✓        | ✓          |
| Push     | ✓        | ✓       | ⛔ → Pull first | ⛔ → Pull first |
| Status   | ✓        | ✓       | ✓        | ✓          |

### Таймер фонового fetch

```python
# Настраиваемый интервал (по умолчанию 5 минут)
FETCH_INTERVAL_SEC = 300

# Реализация через threading.Timer
# Не выполнять если:
#  - окно плагина закрыто
#  - предыдущий fetch ещё выполняется
#  - SSH-соединение не настроено
```

---

## Архитектура UI (единое окно-панель)

```
┌─────────────────────────────────────────────┐
│  Git Integration              [branch: main]│
│─────────────────────────────────────────────│
│  [Pull]  [Commit]  [Push]  [Status]         │
│─────────────────────────────────────────────│
│  Output:                                    │
│  > Already up to date.                      │
│                                             │
│─────────────────────────────────────────────│
│  [⚙ Settings]  [🔑 SSH Setup]  [? Help]    │
└─────────────────────────────────────────────┘
```

## Параметры генератора SSH-ключей

| Параметр | Значение |
|----------|----------|
| Алгоритм | ed25519 |
| Имя файла | `kicad_forgejo_ed25519` |
| Путь | `~/.ssh/` |
| Passphrase | Спрашивать (можно пустое) |
| При конфликте | Предупредить: использовать / перезаписать / другое имя |
| `~/.ssh/config` | Авто-добавление блока Host |
| Копирование | wxPython clipboard API |

## Нерешённые вопросы (не блокируют старт)

- [ ] Иконка для тулбара — нарисовать или подобрать готовую (24x24 PNG)
- [ ] Тестовый Forgejo-инстанс — есть ли доступ для разработки?
- [ ] KiCad 7 vs 8 — тестировать на обоих или только на одной версии?
